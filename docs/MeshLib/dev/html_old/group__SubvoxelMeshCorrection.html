<!-- HTML header for doxygen 1.11.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<script type="text/javascript">
  !function () {
    var currentHost = window.location.hostname;
    var currentPath = window.location.pathname;
    if (currentHost === 'meshinspector.github.io' && !currentPath.includes('/MeshLib/dev/')) {
      var newPath = currentPath.replace('/MeshLib/html', '/documentation');
      var newURL = 'https://meshlib.io' + newPath + window.location.search + window.location.hash;
      window.location.replace(newURL);
    }
  }();
</script>
<script>
  !function(){var i="analytics",analytics=window[i]=window[i]||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","debug","page","screen","once","off","on","addSourceMiddleware","addIntegrationMiddleware","setAnonymousId","addDestinationMiddleware","register"];analytics.factory=function(e){return function(){if(window[i].initialized)return window[i][e].apply(window[i],arguments);var n=Array.prototype.slice.call(arguments);if(["track","screen","alias","group","page","identify"].indexOf(e)>-1){var c=document.querySelector("link[rel='canonical']");n.push({__t:"bpc",c:c&&c.getAttribute("href")||void 0,p:location.pathname,u:location.href,s:location.search,t:document.title,r:document.referrer})}n.unshift(e);analytics.push(n);return analytics}};for(var n=0;n<analytics.methods.length;n++){var key=analytics.methods[n];analytics[key]=analytics.factory(key)}analytics.load=function(key,n){var t=document.createElement("script");t.type="text/javascript";t.async=!0;t.setAttribute("data-global-segment-analytics-key",i);t.src="https://cdn.segment.com/analytics.js/v1/" + key + "/analytics.min.js";var r=document.getElementsByTagName("script")[0];r.parentNode.insertBefore(t,r);analytics._loadOptions=n};analytics._writeKey="Fi7y6F1GgFvTTomYo8zvETBoGHkDDxGx";;analytics.SNIPPET_VERSION="5.2.0";
  analytics.load("Fi7y6F1GgFvTTomYo8zvETBoGHkDDxGx");
  analytics.page();
  }}();
</script>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-MBPLX27B');</script>
  <!-- End Google Tag Manager -->
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.11.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MeshLib Documentation: Subvoxel Mesh Correction</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="CustomStyle.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
    DoxygenAwesomeDarkModeToggle.init()
</script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript">
    DoxygenAwesomeInteractiveToc.init()
</script>
<script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
<script type="text/javascript">
    DoxygenAwesomeTabs.init()
</script>
</head>
<body>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MBPLX27B"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="favicon.ico"/></td>
  <td id="projectalign">
   <div id="projectname">MeshLib Documentation
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.11.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('group__SubvoxelMeshCorrection.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">Subvoxel Mesh Correction<div class="ingroups"><a class="el" href="group__VoxelGroup.html">Voxel</a></div></div></div>
</div><!--header-->
<div class="contents">

<p>Precise automatic mesh correction or/and smoothing based on reference voxel (volume) data.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="nested-classes" name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structMR_1_1MoveMeshToVoxelMaxDerivSettings.html">MR::MoveMeshToVoxelMaxDerivSettings</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classMR_1_1MeshOnVoxelsT.html">MR::MeshOnVoxelsT&lt; MeshType &gt;</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:gadd963001b21876433757b659c99a0818" id="r_gadd963001b21876433757b659c99a0818"><td class="memItemLeft" align="right" valign="top"><a class="el" href="MRVoxels_2MRVoxelsFwd_8h.html#a5a563214874b42adf9d3bbba08988cad">MRVOXELS_API</a> <a class="el" href="namespaceMR.html#a6d7483b6adbc485e9c9b52eb09cb7735">Expected</a>&lt; VertBitSet &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#gadd963001b21876433757b659c99a0818">MR::moveMeshToVoxelMaxDeriv</a> (<a class="el" href="structMR_1_1Mesh.html">Mesh</a> &amp;mesh, const AffineXf3f &amp;meshXf, const VdbVolume &amp;volume, const AffineXf3f &amp;volumeXf, const <a class="el" href="structMR_1_1MoveMeshToVoxelMaxDerivSettings.html">MoveMeshToVoxelMaxDerivSettings</a> &amp;settings, <a class="el" href="group__BasicStructuresGroup.html#ga51ff94746a41880cd06d3272b5bcf710">ProgressCallback</a> callback={})</td></tr>
<tr class="separator:gadd963001b21876433757b659c99a0818"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>Precise automatic mesh correction or/and smoothing based on reference voxel (volume) data. </p>
<p>This group provides highlevel interface of the algorithm: <a class="el" href="#gadd963001b21876433757b659c99a0818">moveMeshToVoxelMaxDeriv</a> configurable through <a class="el" href="structMR_1_1MoveMeshToVoxelMaxDerivSettings.html">MoveMeshToVoxelMaxDerivSettings</a> and the low-level structure <a class="el" href="classMR_1_1MeshOnVoxelsT.html">MeshOnVoxelsT</a> that allows creation of custom correction strategy.</p>
<h4><a class="anchor" id="description"></a>
Description of the algorithm.</h4>
<ol type="1">
<li><b>Input</b>: <a class="el" href="structMR_1_1Mesh.html">Mesh</a> and VdbVolume with corresponding transforms. The objects must be aligned.</li>
<li>First step is to apply preparation smoothing with force specified by <a class="el" href="structMR_1_1MoveMeshToVoxelMaxDerivSettings.html#a33ab7a3bb2d0ed46b1856e4ba276357c">MoveMeshToVoxelMaxDerivSettings::preparationSmoothForce</a>. This step might be needed if the initial surface is very noisy.</li>
<li>Then the algorithm performs correction iteratively for the total number of iterations specified by <a class="el" href="structMR_1_1MoveMeshToVoxelMaxDerivSettings.html#a9b0d4d2ec2b2868f18da16624979032f">MoveMeshToVoxelMaxDerivSettings::iters</a>.<ol type="a">
<li><p class="startli">Each iteration consist of moving each vertex of the mesh towards its optimal position. More formally, let's denote, \( V = \left\{ ( v_i, n_i ) \right\} \) &ndash; set of vertices and corresponding normals of the mesh, and \( F: \mathbb{R}^3 \rightarrow \mathbb{R} \) &ndash; scalar field of volume &ndash; for each position in the scene, it gives the density of the voxels in this position. For points with non-integer coordinates, the density is interpolated linearly (for details see <a class="el" href="classMR_1_1MeshOnVoxelsT.html">MeshOnVoxelsT</a>).</p>
<p class="startli">The optimal position \( p_i \) of the vertex \( v_i \) is given by fitting the polynomial \( Q_i \) of degree <a class="el" href="structMR_1_1MoveMeshToVoxelMaxDerivSettings.html#ad4bdf9eb1e55187c89fd477134219680">MoveMeshToVoxelMaxDerivSettings::degree</a> to the set of points \( \left\{ F\left( v_i + n_i \cdot k \cdot \text{voxel size} \right) \mid k \in -l \dots l \right\} \) where \( l = \frac{\text{sample points}}{2} \) (see <a class="el" href="structMR_1_1MoveMeshToVoxelMaxDerivSettings.html#a9b3c5026793485f6071bb44a681e1461">MoveMeshToVoxelMaxDerivSettings::samplePoints</a>); and finding the minimum of the derivative of this polynomial.</p>
<p class="startli">Since the <a class="el" href="structMR_1_1MoveMeshToVoxelMaxDerivSettings.html#ad4bdf9eb1e55187c89fd477134219680">MoveMeshToVoxelMaxDerivSettings::degree</a> is limited to \( 6 \), we know that the degree of \( \frac{d^2 Q_i}{dx^2} \) is limited to \( 4 \) and thus the equation \( \frac{d^2 Q_i}{dx^2} \left( x \right) = 0 \) has analytical solution and it gives us the extrema of the derivative. Comparing the evaluations of the polynomial at extrema and on the border of the interval we obtain the optimal position \( p_i \). To sum up:       </p><p class="formulaDsp">
\begin{align*}
            &amp;l = \frac{\text{sample points}}{2} \\
            &amp;N_i \leftarrow \left\{ v_i + n_i \cdot k \cdot \text{voxel size} \mid k = -l \dots l \right\} \\
            &amp;\overline{N_i} \leftarrow \left\{ v_i + n_i \cdot x \cdot \text{voxel size} \mid x \in \left[-l; l\right] \right\} \\
            &amp;Q_i \leftarrow \text{fit polynomial from } \left\{ \left( p, F(p) \right) \mid p \in N_i \right\} \\
            &amp;p_i \leftarrow \min_{x \in \overline{N_i}} \frac{dQ_i}{dx}
       \end{align*}
</p>
<p> Note that we are finding the minimum of \( \frac{dQ_i}{dx} \) analytically over the real interval \( \overline{N_i} \) and not over \( N_i \). This is exactly where the subvoxel precision comes from.</p>
</li>
<li>However, directly using the optimal position has proven to be error-prone, as both voxels and mesh could contain noise. Therefore, we use the following heuristic: instead of moving the vertex \( v_i \) to position \( p_i \), we construct a field of shifts with domain on the mesh vertices \( S : v_i \mapsto \text{clamp}\left( p_i - v_i \right) \) and smooth it with the force specified by <a class="el" href="structMR_1_1MoveMeshToVoxelMaxDerivSettings.html#a13090f3a2bfe03345bd7100d2c634d7f">MoveMeshToVoxelMaxDerivSettings::intermediateSmoothForce</a> for 15 iterations. Then we update the vertices according to the smoothed field:   <p class="formulaDsp">
\[
            v_i \leftarrow v_i + S_{smooth}\left( v_i \right)
       \]
</p>
 and proceed to the next interation.</li>
</ol>
</li>
<li>The algorithm modifies the mesh inplace and returns the set of vertices that were moved during the correction.</li>
</ol>
<p>A nice visualization of <em>why</em> it works could be found in MeshInspector's plugin "Voxels Inspector". Just click on any vertex and you will see the values of \( F, Q_i \) on the interval \( \overline{N_i} \), as well as points of \( N_i \).</p>
<h4><a class="anchor" id="usage"></a>
Usage</h4>
<p>The algorithm can be used in different cases related to the CT-scanning workflows:</p><ul>
<li>To increase precision of the mesh retrieved by marching cubes meshing from a noisy scan.</li>
<li>To smooth a noisy mesh taking into account extra information from voxels. In this case, even if both mesh and voxels are noisy, the result is expected to be better than after a simple smoothing. For this use-case, you might need to increase the force of both preparation and intermidiate smoothings. </li>
</ul>
<h2 class="groupheader">Function Documentation</h2>
<a id="gadd963001b21876433757b659c99a0818" name="gadd963001b21876433757b659c99a0818"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gadd963001b21876433757b659c99a0818">&#9670;&#160;</a></span>moveMeshToVoxelMaxDeriv()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="MRVoxels_2MRVoxelsFwd_8h.html#a5a563214874b42adf9d3bbba08988cad">MRVOXELS_API</a> <a class="el" href="namespaceMR.html#a6d7483b6adbc485e9c9b52eb09cb7735">Expected</a>&lt; VertBitSet &gt; MR::moveMeshToVoxelMaxDeriv </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structMR_1_1Mesh.html">Mesh</a> &amp;</td>          <td class="paramname"><span class="paramname"><em>mesh</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const AffineXf3f &amp;</td>          <td class="paramname"><span class="paramname"><em>meshXf</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const VdbVolume &amp;</td>          <td class="paramname"><span class="paramname"><em>volume</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const AffineXf3f &amp;</td>          <td class="paramname"><span class="paramname"><em>volumeXf</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structMR_1_1MoveMeshToVoxelMaxDerivSettings.html">MoveMeshToVoxelMaxDerivSettings</a> &amp;</td>          <td class="paramname"><span class="paramname"><em>settings</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="group__BasicStructuresGroup.html#ga51ff94746a41880cd06d3272b5bcf710">ProgressCallback</a></td>          <td class="paramname"><span class="paramname"><em>callback</em></span><span class="paramdefsep"> = </span><span class="paramdefval">{}</span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Moves each vertex along its normal to the minimize (with sign, i.e. maximize the absolute value with negative sign) the derivative of voxels.</p>
<dl class="section return"><dt>Returns</dt><dd>Vertices that were moved by the algorithm </dd></dl>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.11.0 </li>
  </ul>
</div>
</body>
</html>
